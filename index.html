<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil de révision multi-cours</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .flashcard-container { perspective: 1000px; min-height: 200px; }
        .flashcard { width: 100%; height: 200px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); overflow-y: auto; text-align: center; }
        .flashcard-front { background-color: #ffffff; color: #1f2937; }
        .flashcard-back { background-color: #4b5563; color: #ffffff; transform: rotateY(180deg); }
        .qcm-option { transition: background-color 0.3s; }
        .qcm-option:hover { background-color: #e5e7eb; }
        .correct-answer { background-color: #d1fae5 !important; border-left: 4px solid #10b981; }
        .incorrect-answer { background-color: #fee2e2 !important; border-left: 4px solid #ef4444; }
        .btn { transition: background-color 0.3s, transform 0.1s; }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.98); }
        .feedback-message { padding: 12px; border-radius: 8px; margin-top: 16px; font-weight: 500; text-align: center; }
        .feedback-correct { background-color: #d1fae5; color: #065f46; }
        .feedback-incorrect { background-color: #fee2e2; color: #991b1b; }
        .hidden { display: none; }
        .question-counter { font-size: 0.9em; color: #6b7280; margin-bottom: 1rem; text-align: center; }
        #generatedJsonOutputTextarea, #githubInstructionsContent, #manualGeminiPromptTextarea { font-family: monospace; font-size: 0.9em; border: 1px solid #d1d5db; padding: 8px; border-radius: 6px; background-color: #f9fafb; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto; }
        #generatedJsonOutputTextarea { min-height: 150px; } 
        .copy-feedback { font-size: 0.8rem; color: #4b5563; margin-left: 8px; }
        .course-button-container { display: inline-flex; align-items: center; margin-right: 8px; margin-bottom: 8px; }
        .delete-course-btn { background-color: transparent; border: none; color: #ef4444; font-size: 1.2em; font-weight: bold; margin-left: 5px; cursor: pointer; padding: 0 5px; line-height: 1; }
        .delete-course-btn:hover { color: #dc2626; }
        .course-section-title { font-size: 1.1em; font-weight: 500; color: #374151; margin-bottom: 0.75rem; margin-top: 1rem; text-align: left; }
        #loadingMessage, #noGitHubCoursesMessage { text-align: center; padding: 10px; font-style: italic; color: #4b5563; }
        .io-section { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .io-section h3 { font-size: 1.1em; font-weight: 500; color: #374151; margin-bottom: 0.75rem; }
        #importFile { display: none; }
        .import-label-btn { cursor: pointer; }
        /* #githubInstructions { margin-top: 1rem; padding: 1rem; background-color: #eef2ff; border: 1px solid #c7d2fe; border-radius: 8px; } */
        /* #githubInstructions h4 { font-weight: 600; color: #4338ca; margin-bottom: 0.5rem; } */
        #adminGithubUploadOptions { margin-top: 10px; padding: 10px; border: 1px dashed #cbd5e1; border-radius: 6px; background-color: #f8fafc; }
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 100%; max-width: 32rem; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; text-align: center; }
        .modal-body { max-height: 60vh; overflow-y: auto; margin-bottom: 1rem; text-align: left; white-space: pre-wrap; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; margin: 1rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .manual-prompt-container { border: 1px solid #e5e7eb; padding: 0.5rem; border-radius: 0.375rem; margin-top: 0.5rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-lg p-6 md:p-8">
        <header class="mb-6 text-center">
            <h1 id="mainTitle" class="text-3xl font-bold text-gray-800">Mon Outil de Révision</h1>
        </header>

        <section id="welcomeSection" class="py-10">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Choisissez un cours à réviser :</h2>
            
            <div>
                <h3 class="course-section-title">Cours partagés (depuis GitHub) :</h3>
                <div id="githubCourseListContainer" class="flex flex-wrap justify-center md:justify-start"></div>
                 <p id="loadingMessage">Chargement des cours depuis GitHub...</p>
                 <p id="noGitHubCoursesMessage" class="text-gray-500 text-sm mt-2 text-center md:text-left hidden">Aucun cours partagé n'a pu être chargé. Vérifiez la configuration et les fichiers sur GitHub.</p>
            </div>

            <div class="mt-6">
                <h3 class="course-section-title">Vos cours personnels (stockés localement) :</h3>
                <div id="localCourseListContainer" class="flex flex-wrap justify-center md:justify-start"></div>
                <p id="noLocalCoursesMessage" class="text-gray-500 text-sm mt-2 text-center md:text-left hidden">Aucun cours personnel ajouté pour le moment.</p>
            </div>

            <div class="text-center mt-8">
                <button id="showAddCourseSectionBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md">Ajouter un cours personnel</button>
            </div>

            <div class="io-section text-center md:text-left">
                <h3 class="text-center md:text-left">Gestion des données des cours :</h3>
                <div class="flex flex-col md:flex-row justify-center md:justify-start space-y-2 md:space-y-0 md:space-x-3 mt-2">
                    <button id="exportCoursesBtn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Exporter des cours</button>
                    <label for="importFile" class="btn bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md import-label-btn">Importer des cours</label>
                    <input type="file" id="importFile" accept=".json">
                </div>
                <div id="importOptionsContainer" class="mt-4 hidden">
                    <label class="flex items-center">
                        <input type="checkbox" id="uploadToGithubCheckbox" class="form-checkbox h-5 w-5 text-indigo-600">
                        <span class="ml-2 text-sm text-gray-700">Téléverser ce fichier sur GitHub (Admin - pour un seul cours à la fois)</span>
                    </label>
                    <div id="adminGithubUploadOptions" class="hidden mt-2 space-y-2">
                        <div>
                            <label for="githubPat" class="block text-xs font-medium text-gray-700">Token d'Accès Personnel GitHub (PAT) :</label>
                            <input type="password" id="githubPat" class="mt-1 block w-full sm:w-1/2 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="Collez votre PAT GitHub ici">
                             <p class="text-xs text-gray-500 mt-1">Requis pour écrire sur GitHub. Ne sera pas stocké.</p>
                        </div>
                         <button id="confirmImportBtn" class="btn bg-teal-500 hover:bg-teal-600 text-white font-semibold py-1 px-3 text-sm rounded-lg shadow-md">Confirmer l'importation et téléverser</button>
                    </div>
                     <button id="confirmLocalImportBtn" class="btn bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 text-sm rounded-lg shadow-md mt-2">Importer localement seulement</button>
                </div>
                <p id="ioFeedback" class="text-sm text-gray-600 mt-3 text-center md:text-left"></p>
            </div>
        </section>

        <div id="exportModal" class="modal hidden">
            <div class="modal-content">
                <h3 class="modal-header">Exporter des Cours</h3>
                <div id="exportCourseList" class="modal-body">
                    {/* Les cases à cocher des cours seront injectées ici */}
                </div>
                <div id="exportFeedback" class="text-sm text-red-500 my-2 text-center"></div>
                <div class="modal-footer">
                    <button id="downloadSelectedCoursesBtn" class="btn bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Télécharger la sélection</button>
                    <button id="closeExportModalBtn" class="btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md">Annuler</button>
                </div>
            </div>
        </div>

        <section id="addCourseSection" class="hidden py-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Ajouter un nouveau cours personnel</h2>
            <div class="mb-4">
                <label for="newCourseName" class="block text-sm font-medium text-gray-700 mb-1">Nom du nouveau cours :</label>
                <input type="text" id="newCourseName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ex: Mon Cours d'Histoire">
            </div>
            
            <div class="mb-2">
                 <button id="showManualPromptBtn" class="text-sm text-blue-600 hover:underline">Afficher/Copier le prompt pour génération manuelle avec un LLM</button>
            </div>
            <div id="manualPromptContainer" class="manual-prompt-container hidden mb-4">
                <p class="text-xs text-gray-600 mb-1">Utilisez ce prompt avec un outil comme Gemini si vous souhaitez générer le JSON vous-même :</p>
                <textarea id="manualGeminiPromptTextarea" rows="5" readonly class="w-full text-xs"></textarea>
                <button id="copyManualPromptBtn" class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-md shadow-sm mt-1 text-xs">Copier ce Prompt</button>
                <span id="copyManualPromptFeedback" class="copy-feedback hidden"></span>
            </div>

            <div class="mb-6">
                <label for="generatedJsonOutputTextarea" class="block text-sm font-medium text-gray-700 mb-1">Collez ici le JSON du cours (préparé manuellement ou généré par un LLM externe) :</label>
                <textarea id="generatedJsonOutputTextarea" rows="8" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Collez le JSON ici..."></textarea>
            </div>
            
            <!-- <div class="mb-4">
                <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe administrateur (optionnel, pour aide à l'ajout manuel sur GitHub) :</label>
                <input type="password" id="adminPassword" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Entrez 'JuLhui' pour instructions">
            </div> -->
            <div id="addCourseFeedback" class="feedback-message hidden mb-4"></div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="saveCourseBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Sauvegarder le cours personnel</button>
                <button id="backToWelcomeFromAddBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Retour à l'accueil</button>
            </div>
        </section>

        <section id="modeSelectionSection" class="hidden text-center py-10">
            <h2 id="modeSelectionTitle" class="text-2xl font-semibold text-gray-700 mb-6"></h2>
            <div class="space-y-4 md:space-y-0 md:space-x-4 md:flex md:justify-center">
                <button id="showFlashcardsBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md w-full md:w-auto">Cartes Flash</button>
                <button id="showQcmBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md w-full md:w-auto">QCM</button>
            </div>
            <button id="backToWelcomeFromModeBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md mt-8">Retour à l'accueil</button>
        </section>

        <section id="flashcardsSection" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2 text-center">Cartes Flash</h2>
            <div id="flashcardCounter" class="question-counter"></div>
            <div id="flashcardContainer" class="flashcard-container mb-4">
                <div id="flashcard" class="flashcard">
                    <div class="flashcard-face flashcard-front"><p id="flashcardQuestion" class="text-lg"></p></div>
                    <div class="flashcard-face flashcard-back"><p id="flashcardAnswer" class="text-lg"></p></div>
                </div>
            </div>
            <div id="flashcardMessage" class="text-sm text-gray-500 text-center mb-4 h-6">Cliquez sur la carte pour voir la réponse.</div>
            <div class="flex justify-center space-x-4">
                <button id="nextFlashcardBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Suivante</button>
            </div>
            <button id="backToModeSelectionFromFlashcardsBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md mt-6 block mx-auto">Retour au choix du mode</button>
        </section>

        <section id="qcmSection" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2 text-center">Questionnaire à Choix Multiples</h2>
            <div id="qcmCounter" class="question-counter"></div>
            <div id="qcmContainer" class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <p id="qcmQuestionElement" class="text-lg font-medium text-gray-800 mb-4"></p> 
                <div id="qcmOptions" class="space-y-3 mb-4"></div>
                <div id="qcmFeedback" class="feedback-message hidden"></div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                 <button id="submitQcmBtn" class="btn bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-semibold py-2 px-6 rounded-lg shadow-md">Valider</button>
                <button id="nextQcmBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md hidden">Suivant</button>
            </div>
            <button id="backToModeSelectionFromQcmBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md mt-6 block mx-auto">Retour au choix du mode</button>
        </section>
    </div>

    <script>
        const USER_COURSES_LOCAL_STORAGE_KEY = 'revisionAppUserCourses_v2';
        let gitHubCoursesData = {}; 
        let userCoursesData = {};   
        let currentCourseKey = null;
        let currentFlashcardIndex = 0;
        let currentQcmIndex = 0;
        let selectedQcmOption = null;
        // const ADMIN_PASSWORD_MANUAL_GITHUB_HELPER = "JuLhui"; // Retiré car la fonctionnalité associée est retirée

        // !!! VÉRIFIEZ BIEN CES CONSTANTES !!!
        const GITHUB_USER_REPO = 'JulienLhui/cyoutilrevision'; 
        const GITHUB_BRANCH = 'main'; 
        const GITHUB_COURSES_DIRECTORY_PATH = 'cours'; 
        // !!! ------------------------------------ !!!

        const mainTitle = document.getElementById('mainTitle');
        const welcomeSection = document.getElementById('welcomeSection');
        const githubCourseListContainer = document.getElementById('githubCourseListContainer');
        const localCourseListContainer = document.getElementById('localCourseListContainer');
        const noLocalCoursesMessage = document.getElementById('noLocalCoursesMessage');
        const showAddCourseSectionBtn = document.getElementById('showAddCourseSectionBtn');
        
        const addCourseSection = document.getElementById('addCourseSection');
        const newCourseNameInput = document.getElementById('newCourseName');
        const generatedJsonOutputTextarea = document.getElementById('generatedJsonOutputTextarea'); 
        const showManualPromptBtn = document.getElementById('showManualPromptBtn');
        const manualPromptContainer = document.getElementById('manualPromptContainer');
        const manualGeminiPromptTextarea = document.getElementById('manualGeminiPromptTextarea');
        const copyManualPromptBtn = document.getElementById('copyManualPromptBtn');
        const copyManualPromptFeedback = document.getElementById('copyManualPromptFeedback');

        // const adminPasswordInput = document.getElementById('adminPassword'); // Retiré
        const saveCourseBtn = document.getElementById('saveCourseBtn');
        const backToWelcomeFromAddBtn = document.getElementById('backToWelcomeFromAddBtn');
        const addCourseFeedback = document.getElementById('addCourseFeedback');
        // const githubInstructionsDiv = document.getElementById('githubInstructions'); // Retiré
        // const suggestedFileNameElement = document.getElementById('suggestedFileName'); // Retiré
        // const githubInstructionsContentElement = document.getElementById('githubInstructionsContent'); // Retiré
        // const copyGithubJsonBtn = document.getElementById('copyGithubJsonBtn'); // Retiré
        // const copyGithubJsonFeedback = document.getElementById('copyGithubJsonFeedback'); // Retiré
        // const githubRepoLink = document.getElementById('githubRepoLink'); // Retiré

        const loadingMessage = document.getElementById('loadingMessage');
        const noGitHubCoursesMessage = document.getElementById('noGitHubCoursesMessage');
        
        const modeSelectionSection = document.getElementById('modeSelectionSection');
        const modeSelectionTitle = document.getElementById('modeSelectionTitle');
        const showFlashcardsBtn = document.getElementById('showFlashcardsBtn');
        const showQcmBtn = document.getElementById('showQcmBtn');
        
        const flashcardsSection = document.getElementById('flashcardsSection');
        const flashcardElement = document.getElementById('flashcard'); 
        const flashcardQuestion = document.getElementById('flashcardQuestion');
        const flashcardAnswer = document.getElementById('flashcardAnswer');
        const nextFlashcardBtn = document.getElementById('nextFlashcardBtn');
        const flashcardMessage = document.getElementById('flashcardMessage');
        const flashcardCounter = document.getElementById('flashcardCounter');

        const qcmSection = document.getElementById('qcmSection');
        const qcmQuestionElement = document.getElementById('qcmQuestionElement');
        const qcmOptionsContainer = document.getElementById('qcmOptions');
        const submitQcmBtn = document.getElementById('submitQcmBtn');
        const nextQcmBtn = document.getElementById('nextQcmBtn');
        const qcmFeedback = document.getElementById('qcmFeedback');
        const qcmCounter = document.getElementById('qcmCounter');

        const backToWelcomeFromModeBtn = document.getElementById('backToWelcomeFromModeBtn');
        const backToModeSelectionFromFlashcardsBtn = document.getElementById('backToModeSelectionFromFlashcardsBtn');
        const backToModeSelectionFromQcmBtn = document.getElementById('backToModeSelectionFromQcmBtn');
        
        const exportCoursesBtn = document.getElementById('exportCoursesBtn');
        const importFile = document.getElementById('importFile');
        const ioFeedback = document.getElementById('ioFeedback');
        const importOptionsContainer = document.getElementById('importOptionsContainer');
        const uploadToGithubCheckbox = document.getElementById('uploadToGithubCheckbox');
        const adminGithubUploadOptionsDiv = document.getElementById('adminGithubUploadOptions');
        const githubPatInput = document.getElementById('githubPat');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const confirmLocalImportBtn = document.getElementById('confirmLocalImportBtn');
        
        const exportModal = document.getElementById('exportModal');
        const exportCourseList = document.getElementById('exportCourseList');
        const exportFeedback = document.getElementById('exportFeedback');
        const downloadSelectedCoursesBtn = document.getElementById('downloadSelectedCoursesBtn');
        const closeExportModalBtn = document.getElementById('closeExportModalBtn');

        let selectedFileForImport = null; 

        const GEMINI_PROMPT_FOR_USER_MANUAL_GENERATION = `Bonjour, j'ai un cours que j'aimerais transformer en fiches de révision et QCM pour un outil d'étude.

Merci de générer à partir du contenu de cours que je vais vous fournir :
1.  Une liste de cartes flash (questions concises et réponses directes).
2.  Une liste de questions à choix multiples (QCM) avec 3 ou 4 options de réponse et une seule bonne réponse clairement identifiée.

Veuillez fournir la sortie sous la forme d'un unique objet JSON valide, structuré exactement comme suit (ne modifiez pas les noms des clés) :
{
  "title": "METTRE ICI LE TITRE EXACT DU COURS FOURNI",
  "flashcards": [
    { "question": "Question pour la carte flash 1...", "answer": "Réponse pour la carte flash 1..." },
    { "question": "Question pour la carte flash 2...", "answer": "Réponse pour la carte flash 2..." }
  ],
  "qcm": [
    { "question": "Question QCM 1...", "options": ["Option A", "Option B", "Option C", "Option D (si applicable)"], "correctAnswer": "Option correcte pour QCM 1" },
    { "question": "Question QCM 2...", "options": ["Option A", "Option B", "Option C"], "correctAnswer": "Option correcte pour QCM 2" }
  ]
}

Le champ "title" doit être une chaîne de caractères.
"flashcards" doit être un tableau d'objets, chaque objet ayant impérativement les clés "question" et "answer" (chaînes de caractères).
"qcm" doit être un tableau d'objets, chaque objet ayant impérativement les clés "question" (chaîne), "options" (tableau de chaînes), et "correctAnswer" (chaîne de caractères).

**Instruction importante pour les QCM :** La valeur du champ "correctAnswer" doit être une copie **exacte** de l'une des chaînes de caractères fournies dans le tableau "options" pour cette question. Si une option de réponse contient un marqueur de citation (par exemple, \`[cite: X]\`), et que cette option est la bonne réponse, alors le champ "correctAnswer" doit aussi inclure ce marqueur de citation tel quel. N'ajoutez aucun texte supplémentaire ou modification à la "correctAnswer" qui ne soit pas présent tel quel dans les "options".

Voici le contenu de mon cours :
[COLLEZ LE CONTENU DE VOTRE COURS ICI]`;


        function loadUserCoursesFromLocalStorage() { 
            console.log("LOCAL_STORAGE_LOAD: Tentative de chargement des cours utilisateur.");
            const storedUserCourses = localStorage.getItem(USER_COURSES_LOCAL_STORAGE_KEY);
            if (storedUserCourses) {
                try {
                    userCoursesData = JSON.parse(storedUserCourses);
                    if (typeof userCoursesData !== 'object' || userCoursesData === null) {
                        userCoursesData = {}; 
                    }
                    console.log("LOCAL_STORAGE_LOAD: Cours utilisateur chargés:", userCoursesData);
                } catch (error) {
                    console.error("LOCAL_STORAGE_LOAD: Erreur de parsing des cours utilisateur:", error);
                    userCoursesData = {};
                }
            } else {
                userCoursesData = {};
                console.log("LOCAL_STORAGE_LOAD: Aucun cours utilisateur trouvé dans localStorage.");
            }
        }
        function saveUserCoursesToLocalStorage() { 
            console.log("LOCAL_STORAGE_SAVE: Tentative de sauvegarde des cours utilisateur:", userCoursesData);
            try {
                localStorage.setItem(USER_COURSES_LOCAL_STORAGE_KEY, JSON.stringify(userCoursesData));
                console.log("LOCAL_STORAGE_SAVE: Cours utilisateur sauvegardés avec succès.");
            } catch (error) {
                console.error("LOCAL_STORAGE_SAVE: Erreur de sauvegarde des cours utilisateur:", error);
                ioFeedback.textContent = "Erreur lors de la sauvegarde des cours personnels.";
                ioFeedback.style.color = "red";
                setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
            }
        }
        async function fetchAndValidateCourseContent(downloadUrl, fileNameForLogging) { 
            console.log(`GITHUB_FETCH: Tentative de chargement du contenu de ${fileNameForLogging} depuis ${downloadUrl}`);
            try {
                const response = await fetch(downloadUrl);
                if (!response.ok) {
                    console.error(`GITHUB_FETCH: Erreur HTTP! Statut: ${response.status}, Texte: ${response.statusText} pour ${fileNameForLogging} (URL: ${downloadUrl})`);
                    throw new Error(`HTTP error! status: ${response.status} pour ${fileNameForLogging}`);
                }
                const data = await response.json();
                if (data && typeof data.title === 'string' && Array.isArray(data.flashcards) && Array.isArray(data.qcm)) {
                    const flashcardsValid = data.flashcards.every(fc => typeof fc.question === 'string' && typeof fc.answer === 'string');
                    const qcmValid = data.qcm.every(q => {
                        if (typeof q.question !== 'string' || !Array.isArray(q.options) || typeof q.correctAnswer !== 'string') return false;
                        return q.options.includes(q.correctAnswer); 
                    });
                    if (flashcardsValid && qcmValid) {
                        return { key: fileNameForLogging.replace('.json', ''), data: data };
                    } else {
                        console.error(`GITHUB_FETCH: Structure de contenu invalide dans ${fileNameForLogging}.`);
                        return null;
                    }
                } else {
                     console.error(`GITHUB_FETCH: Structure JSON principale invalide pour ${fileNameForLogging}.`);
                    return null;
                }
            } catch (error) {
                console.error(`GITHUB_FETCH: Erreur lors du traitement de ${fileNameForLogging}:`, error);
                return null;
            }
        }
        async function loadCoursesFromGitHub() { 
            console.log("GITHUB_FETCH: Début du chargement des cours partagés...");
            loadingMessage.classList.remove('hidden');
            noGitHubCoursesMessage.classList.add('hidden'); 
            
            const apiUrl = `https://api.github.com/repos/${GITHUB_USER_REPO}/contents/${GITHUB_COURSES_DIRECTORY_PATH}?ref=${GITHUB_BRANCH}`;
            console.log(`GITHUB_FETCH: Interrogation API: ${apiUrl}`);

            let filesToFetch = [];
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error(`GITHUB_FETCH: Erreur API GitHub! Statut: ${response.status}, (URL: ${apiUrl})`);
                    throw new Error(`GitHub API error! status: ${response.status}`);
                }
                const directoryContents = await response.json();
                if (Array.isArray(directoryContents)) {
                    filesToFetch = directoryContents
                        .filter(item => item.type === 'file' && item.name.endsWith('.json'))
                        .map(item => ({ name: item.name, download_url: item.download_url }));
                    console.log("GITHUB_FETCH: Fichiers JSON trouvés:", filesToFetch.map(f => f.name));
                } else {
                    console.error("GITHUB_FETCH: Réponse API GitHub non conforme (pas un tableau).", directoryContents);
                }
            } catch (error) {
                console.error("GITHUB_FETCH: Erreur récupération liste fichiers:", error);
                loadingMessage.classList.add('hidden');
                noGitHubCoursesMessage.classList.remove('hidden'); 
                return; 
            }

            if (filesToFetch.length === 0 && GITHUB_COURSES_DIRECTORY_PATH) { 
                console.warn("GITHUB_FETCH: Aucun fichier .json trouvé dans le dossier GitHub:", GITHUB_COURSES_DIRECTORY_PATH);
                noGitHubCoursesMessage.classList.remove('hidden'); 
            }

            const coursePromises = filesToFetch.map(fileInfo => fetchAndValidateCourseContent(fileInfo.download_url, fileInfo.name));
            const results = await Promise.all(coursePromises);

            gitHubCoursesData = {}; 
            results.forEach(result => {
                if (result && result.data) {
                    gitHubCoursesData[result.key] = result.data;
                    console.log(`GITHUB_FETCH: Cours partagé "${result.data.title}" (clé: ${result.key}) chargé.`);
                }
            });
            
            loadingMessage.classList.add('hidden');
            if (Object.keys(gitHubCoursesData).length === 0 && filesToFetch.length > 0) {
                 console.warn("GITHUB_FETCH: Fichiers JSON détectés mais aucun cours partagé n'a pu être chargé correctement.");
                 noGitHubCoursesMessage.classList.remove('hidden');
            } else if (filesToFetch.length === 0 && GITHUB_COURSES_DIRECTORY_PATH) {
            } else if (Object.keys(gitHubCoursesData).length > 0) {
                noGitHubCoursesMessage.classList.add('hidden'); 
            }
        }
        
        function showWelcomeScreen() { 
            mainTitle.textContent = "Mon Outil de Révision";
            welcomeSection.classList.remove('hidden');
            addCourseSection.classList.add('hidden');
            modeSelectionSection.classList.add('hidden');
            flashcardsSection.classList.add('hidden');
            qcmSection.classList.add('hidden');
            exportModal.classList.add('hidden'); 
            currentCourseKey = null;
            importOptionsContainer.classList.add('hidden'); 
            uploadToGithubCheckbox.checked = false;
            adminGithubUploadOptionsDiv.classList.add('hidden');
            githubPatInput.value = '';
            populateCourseList();
        }
        function showAddCourseScreen() { 
            mainTitle.textContent = "Ajouter un Nouveau Cours Personnel";
            welcomeSection.classList.add('hidden');
            addCourseSection.classList.remove('hidden');
            modeSelectionSection.classList.add('hidden');
            flashcardsSection.classList.add('hidden');
            qcmSection.classList.add('hidden');
            
            newCourseNameInput.value = '';
            generatedJsonOutputTextarea.value = ''; 
            // adminPasswordInput.value = ''; // Retiré
            addCourseFeedback.classList.add('hidden');
            // githubInstructionsDiv.classList.add('hidden'); // Retiré
            manualPromptContainer.classList.add('hidden'); 
            manualGeminiPromptTextarea.value = GEMINI_PROMPT_FOR_USER_MANUAL_GENERATION;
            copyManualPromptFeedback.classList.add('hidden');

            //  if(githubRepoLink) { // Retiré car githubInstructionsDiv est retiré
            //     githubRepoLink.href = `https://github.com/${GITHUB_USER_REPO}/tree/${GITHUB_BRANCH}/${GITHUB_COURSES_DIRECTORY_PATH}`;
            // }
        }
        function populateCourseList() { 
            githubCourseListContainer.innerHTML = ''; 
            localCourseListContainer.innerHTML = '';
            let localCoursesExist = false;
            
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData }; 

            Object.keys(gitHubCoursesData).forEach(key => {
                const course = gitHubCoursesData[key];
                const buttonContainer = document.createElement('div');
                buttonContainer.classList.add('course-button-container');
                const button = createCourseButton(key, course.title, combinedCourses);
                buttonContainer.appendChild(button);
                githubCourseListContainer.appendChild(buttonContainer);
            });
             if (Object.keys(gitHubCoursesData).length === 0 && loadingMessage.classList.contains('hidden') && GITHUB_COURSES_DIRECTORY_PATH) {
                 noGitHubCoursesMessage.classList.remove('hidden');
            } else {
                 noGitHubCoursesMessage.classList.add('hidden');
            }

            Object.keys(userCoursesData).forEach(key => {
                if (!gitHubCoursesData[key]) { 
                    localCoursesExist = true;
                    const course = userCoursesData[key];
                    const buttonContainer = document.createElement('div');
                    buttonContainer.classList.add('course-button-container');
                    const button = createCourseButton(key, course.title, combinedCourses);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&#x2715;'; 
                    deleteBtn.classList.add('delete-course-btn');
                    deleteBtn.title = `Supprimer le cours "${course.title}"`;
                    deleteBtn.addEventListener('click', (event) => {
                        event.stopPropagation(); 
                        deleteUserCourse(key, course.title);
                    });
                    buttonContainer.appendChild(button);
                    buttonContainer.appendChild(deleteBtn);
                    localCourseListContainer.appendChild(buttonContainer);
                }
            });

            if (localCoursesExist) {
                noLocalCoursesMessage.classList.add('hidden');
            } else {
                noLocalCoursesMessage.classList.remove('hidden');
            }
        }
        function createCourseButton(key, title, sourceDataForColoring) { 
            const button = document.createElement('button');
            button.dataset.course = key;
            button.classList.add('course-btn', 'btn', 'text-white', 'font-semibold', 'py-2', 'px-4', 'rounded-lg', 'shadow-md');
            const colors = ['bg-sky-600 hover:bg-sky-700', 'bg-teal-600 hover:bg-teal-700', 'bg-indigo-600 hover:bg-indigo-700', 'bg-rose-600 hover:bg-rose-700', 'bg-amber-600 hover:bg-amber-700'];
            const allKeys = Object.keys(sourceDataForColoring);
            const colorIndex = allKeys.indexOf(key) % colors.length;
            const colorClass = colors[colorIndex >= 0 ? colorIndex : 0]; 
            button.classList.add(...colorClass.split(' '));
            button.textContent = title;
            button.addEventListener('click', () => {
                currentCourseKey = key; 
                currentFlashcardIndex = 0; 
                currentQcmIndex = 0;
                showModeSelectionScreen();
            });
            return button;
        }
        function deleteUserCourse(courseKey, courseTitle) { 
            console.log(`LOCAL_STORAGE_DELETE: Suppression du cours utilisateur. Clé: ${courseKey}, Titre: ${courseTitle}`);
            delete userCoursesData[courseKey]; 
            saveUserCoursesToLocalStorage();
            populateCourseList(); 
            ioFeedback.textContent = `Le cours personnel "${courseTitle}" a été supprimé.`;
            ioFeedback.style.color = "orange";
            setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
        }
        function showModeSelectionScreen() { 
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!currentCourseKey || !combinedCourses[currentCourseKey]) { 
                 console.error("Attempting to access non-existent course:", currentCourseKey);
                 showWelcomeScreen(); 
                 return;
            }
            mainTitle.textContent = `Révision : ${combinedCourses[currentCourseKey].title}`;
            modeSelectionTitle.textContent = `Cours : ${combinedCourses[currentCourseKey].title}. Choisissez un mode :`;
            welcomeSection.classList.add('hidden');
            addCourseSection.classList.add('hidden');
            modeSelectionSection.classList.remove('hidden');
            flashcardsSection.classList.add('hidden');
            qcmSection.classList.add('hidden');
        }
        function showFlashcardsScreen() { 
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!currentCourseKey || !combinedCourses[currentCourseKey]) { showWelcomeScreen(); return; }
            mainTitle.textContent = `Cartes Flash : ${combinedCourses[currentCourseKey].title}`;
            modeSelectionSection.classList.add('hidden');
            flashcardsSection.classList.remove('hidden');
            qcmSection.classList.add('hidden');
            displayFlashcard();
        }
        function showQcmScreen() { 
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!currentCourseKey || !combinedCourses[currentCourseKey]) { showWelcomeScreen(); return; }
            mainTitle.textContent = `QCM : ${combinedCourses[currentCourseKey].title}`;
            modeSelectionSection.classList.add('hidden');
            flashcardsSection.classList.add('hidden');
            qcmSection.classList.remove('hidden');
            displayQcm();
        }
        function displayFlashcard() { 
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!combinedCourses[currentCourseKey] || !combinedCourses[currentCourseKey].flashcards) { 
                flashcardQuestion.textContent = "Erreur : Données de flashcards non trouvées pour ce cours.";
                flashcardElement.classList.add('hidden');
                nextFlashcardBtn.classList.add('hidden');
                flashcardCounter.textContent = "0/0";
                return;
            }
            const courseFlashcards = combinedCourses[currentCourseKey].flashcards;
            if (courseFlashcards.length === 0) { 
                flashcardQuestion.textContent = "Aucune carte flash disponible pour ce cours.";
                flashcardAnswer.textContent = "";
                flashcardMessage.textContent = "Vérifiez le fichier JSON du cours.";
                nextFlashcardBtn.classList.add('hidden');
                flashcardElement.classList.add('hidden');
                flashcardCounter.textContent = "0/0";
                return;
            }
            flashcardElement.classList.remove('hidden');
            nextFlashcardBtn.classList.remove('hidden');
            
            const currentCard = courseFlashcards[currentFlashcardIndex];
            flashcardQuestion.textContent = currentCard.question;
            flashcardAnswer.textContent = currentCard.answer;
            flashcardElement.classList.remove('is-flipped');
            flashcardMessage.textContent = "Cliquez sur la carte pour voir la réponse.";
            flashcardCounter.textContent = `${currentFlashcardIndex + 1}/${courseFlashcards.length}`;
        }
        function flipFlashcard() { 
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!currentCourseKey || !combinedCourses[currentCourseKey] || !combinedCourses[currentCourseKey].flashcards || combinedCourses[currentCourseKey].flashcards.length === 0) return;
            flashcardElement.classList.toggle('is-flipped');
             if (flashcardElement.classList.contains('is-flipped')) {
                flashcardMessage.textContent = "Cliquez sur la carte pour voir la question.";
            } else {
                flashcardMessage.textContent = "Cliquez sur la carte pour voir la réponse.";
            }
        }
        function nextFlashcard() { 
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            const courseFlashcards = combinedCourses[currentCourseKey].flashcards;
            if (!courseFlashcards || courseFlashcards.length === 0) return;
            currentFlashcardIndex = (currentFlashcardIndex + 1) % courseFlashcards.length;
            displayFlashcard();
        }
        function displayQcm() { 
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
             if (!combinedCourses[currentCourseKey] || !combinedCourses[currentCourseKey].qcm) { 
                qcmQuestionElement.textContent = "Erreur : Données de QCM non trouvées pour ce cours.";
                qcmOptionsContainer.innerHTML = "";
                submitQcmBtn.classList.add('hidden');
                nextQcmBtn.classList.add('hidden');
                qcmCounter.textContent = "0/0";
                return;
            }
            const courseQCMs = combinedCourses[currentCourseKey].qcm;
            if (courseQCMs.length === 0) { 
                qcmQuestionElement.textContent = "Aucun QCM disponible pour ce cours.";
                qcmOptionsContainer.innerHTML = "";
                submitQcmBtn.classList.add('hidden');
                nextQcmBtn.classList.add('hidden');
                qcmFeedback.classList.add('hidden');
                qcmCounter.textContent = "0/0";
                return;
            }

            submitQcmBtn.classList.remove('hidden');
            nextQcmBtn.classList.add('hidden');
            qcmFeedback.classList.add('hidden');
            qcmFeedback.textContent = '';
            qcmFeedback.className = 'feedback-message hidden';

            const currentQ = courseQCMs[currentQcmIndex];
            qcmQuestionElement.textContent = currentQ.question;
            qcmOptionsContainer.innerHTML = ''; 
            qcmCounter.textContent = `${currentQcmIndex + 1}/${courseQCMs.length}`;

            currentQ.options.forEach(option => {
                const optionId = `qcm-option-${option.replace(/\s+/g, '-').replace(/[^\w-]/g, '')}`;
                const div = document.createElement('div');
                div.classList.add('qcm-option', 'p-3', 'bg-white', 'rounded-lg', 'border', 'border-gray-300', 'cursor-pointer', 'hover:bg-gray-100');
                
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'qcmOption';
                input.value = option;
                input.id = optionId; 
                input.classList.add('mr-3', 'accent-blue-500');

                const label = document.createElement('label');
                label.htmlFor = optionId;
                label.textContent = option;
                label.classList.add('text-gray-700', 'w-full', 'cursor-pointer');

                div.appendChild(input);
                div.appendChild(label);
                
                div.addEventListener('click', () => {
                    document.querySelectorAll('#qcmOptions > div').forEach(d => d.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50'));
                    div.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
                    input.checked = true; 
                    selectedQcmOption = option;
                    submitQcmBtn.disabled = false; 
                });
                qcmOptionsContainer.appendChild(div);
            });
            selectedQcmOption = null; 
            submitQcmBtn.disabled = true; 
        }
        function submitQcm() { 
            if (selectedQcmOption === null) {
                qcmFeedback.textContent = "Veuillez sélectionner une réponse.";
                qcmFeedback.className = 'feedback-message feedback-incorrect';
                qcmFeedback.classList.remove('hidden');
                return;
            }
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            const currentQ = combinedCourses[currentCourseKey].qcm[currentQcmIndex];
            const isCorrect = selectedQcmOption === currentQ.correctAnswer;

            qcmFeedback.classList.remove('hidden');
            if (isCorrect) {
                qcmFeedback.textContent = "Bonne réponse !";
                qcmFeedback.className = 'feedback-message feedback-correct';
            } else {
                qcmFeedback.textContent = `Mauvaise réponse. La bonne réponse était : ${currentQ.correctAnswer}`;
                qcmFeedback.className = 'feedback-message feedback-incorrect';
            }

            const optionsDivs = qcmOptionsContainer.querySelectorAll('div');
            optionsDivs.forEach(div => {
                const input = div.querySelector('input');
                div.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50'); 
                div.style.pointerEvents = 'none'; 

                if (input.value === currentQ.correctAnswer) { 
                    div.classList.add('correct-answer');
                } else if (input.value === selectedQcmOption && !isCorrect) {
                    div.classList.add('incorrect-answer');
                }
            });

            submitQcmBtn.classList.add('hidden'); 
            nextQcmBtn.classList.remove('hidden'); 
        }
        function nextQcm() { 
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            const courseQCMs = combinedCourses[currentCourseKey].qcm;
            if (!courseQCMs || courseQCMs.length === 0) return;
            currentQcmIndex = (currentQcmIndex + 1) % courseQCMs.length;
            displayQcm();
            submitQcmBtn.classList.remove('hidden'); 
            nextQcmBtn.classList.add('hidden'); 
            qcmFeedback.classList.add('hidden'); 
            
            const optionsDivs = qcmOptionsContainer.querySelectorAll('div');
            optionsDivs.forEach(div => {
                div.style.pointerEvents = 'auto';
            });
        }
        
        function saveNewCourse() { 
            const courseName = newCourseNameInput.value.trim();
            const courseDataJSON = generatedJsonOutputTextarea.value.trim(); 
            // const adminPass = adminPasswordInput.value; // Retiré de la logique principale de sauvegarde

            addCourseFeedback.classList.add('hidden');
            // githubInstructionsDiv.classList.add('hidden'); // Retiré

            if (!courseName) {
                addCourseFeedback.textContent = "Veuillez donner un nom à votre cours.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }
            if (!courseDataJSON) { 
                addCourseFeedback.textContent = "Veuillez coller les données JSON de votre cours.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }
            
             let newCourseContent;
            try {
                newCourseContent = JSON.parse(courseDataJSON);
            } catch (error) {
                addCourseFeedback.textContent = "Erreur : Le format JSON est invalide.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }
            if (!newCourseContent.title || typeof newCourseContent.title !== 'string' ||
                !Array.isArray(newCourseContent.flashcards) || 
                !Array.isArray(newCourseContent.qcm)) {
                addCourseFeedback.textContent = "Erreur : Structure JSON incorrecte (title, flashcards, qcm requis).";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }
            
            const flashcardsValid = newCourseContent.flashcards.every(fc => typeof fc.question === 'string' && typeof fc.answer === 'string');
            const qcmValid = newCourseContent.qcm.every(q => {
                if (typeof q.question !== 'string' || !Array.isArray(q.options) || typeof q.correctAnswer !== 'string') return false;
                return q.options.includes(q.correctAnswer);
            });

            if (!flashcardsValid || !qcmValid) {
                 addCourseFeedback.textContent = "Erreur : Structure interne des flashcards/QCM incorrecte.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }

            const courseKey = "user-" + courseName.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
            
            const githubEquivalentKeyFromName = courseName.toLowerCase().replace(/\s+/g, '_').replace(/[^\w_.-]/g, '');
            if (gitHubCoursesData[githubEquivalentKeyFromName]) {
                 addCourseFeedback.textContent = "Erreur : Un cours partagé avec un nom similaire existe déjà. Veuillez choisir un autre nom pour votre cours personnel.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }
            
            userCoursesData[courseKey] = {
                title: courseName, 
                flashcards: newCourseContent.flashcards,
                qcm: newCourseContent.qcm 
            };
            saveUserCoursesToLocalStorage(); 

            addCourseFeedback.textContent = `Le cours personnel "${courseName}" a été ajouté localement avec succès !`;
            addCourseFeedback.className = 'feedback-message feedback-correct';
            addCourseFeedback.classList.remove('hidden');
            
            // La logique pour afficher les instructions GitHub si adminPass est correct est retirée ici
            // car le champ de mot de passe a été retiré de l'interface pour cette action.

            newCourseNameInput.value = ''; 
            generatedJsonOutputTextarea.value = ''; 
            // adminPasswordInput.value = ''; // Retiré

            setTimeout(() => { showWelcomeScreen(); }, 2000);
        }
        function downloadJSON(data, filename) { 
            if (!filename.endsWith('.json')) {
                filename += '.json';
            }
            const jsonDataString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonDataString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openExportModal() {
            exportCourseList.innerHTML = ''; 
            exportFeedback.textContent = '';
            exportFeedback.classList.add('hidden');

            const combinedCourses = {...gitHubCoursesData, ...userCoursesData};
            if (Object.keys(combinedCourses).length === 0) {
                exportCourseList.innerHTML = '<p class="text-sm text-gray-500">Aucun cours disponible à exporter.</p>';
                downloadSelectedCoursesBtn.disabled = true;
            } else {
                downloadSelectedCoursesBtn.disabled = false;
                Object.keys(combinedCourses).forEach(key => {
                    const course = combinedCourses[key];
                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'mb-2');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `export-${key}`;
                    checkbox.value = key;
                    checkbox.classList.add('form-checkbox', 'h-4', 'w-4', 'text-indigo-600', 'transition', 'duration-150', 'ease-in-out');
                    const label = document.createElement('label');
                    label.htmlFor = `export-${key}`;
                    label.textContent = course.title;
                    label.classList.add('ml-2', 'block', 'text-sm', 'leading-5', 'text-gray-900');
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    exportCourseList.appendChild(div);
                });
            }
            exportModal.classList.remove('hidden');
        }

        function handleDownloadSelected() {
            const selectedCoursesKeys = [];
            exportCourseList.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                selectedCoursesKeys.push(checkbox.value);
            });

            if (selectedCoursesKeys.length === 0) {
                exportFeedback.textContent = "Veuillez sélectionner au moins un cours à exporter.";
                exportFeedback.classList.remove('hidden');
                return;
            }

            exportFeedback.classList.add('hidden');
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData};
            let downloadedCount = 0;

            selectedCoursesKeys.forEach(key => {
                const courseDataToExport = combinedCourses[key];
                if (courseDataToExport) {
                    const fileName = key.replace(/^user-/, '').replace(/-[0-9]+$/, '').replace(/[^a-z0-9_]/gi, '_') + '.json';
                    downloadJSON(courseDataToExport, fileName);
                    downloadedCount++;
                }
            });

            if (downloadedCount > 0) {
                ioFeedback.textContent = `${downloadedCount} cours exporté(s) avec succès !`;
                ioFeedback.style.color = "green";
            } else {
                ioFeedback.textContent = "Aucun cours sélectionné n'a pu être exporté.";
                 ioFeedback.style.color = "orange";
            }
            exportModal.classList.add('hidden');
            setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
        }
        
        async function processImport(fileContent, isGitHubUpload, pat) { 
            let importedData;
            try {
                importedData = JSON.parse(fileContent);
            } catch (error) {
                ioFeedback.textContent = "Erreur : Le fichier JSON importé est invalide.";
                ioFeedback.style.color = "red";
                setTimeout(() => { ioFeedback.textContent = ''; importFile.value = '';}, 3000);
                return false;
            }

            if (isGitHubUpload) {
                if (importedData && typeof importedData.title === 'string' && Array.isArray(importedData.flashcards) && Array.isArray(importedData.qcm)) {
                    const fileNameForGithub = selectedFileForImport ? selectedFileForImport.name : importedData.title.toLowerCase().replace(/\s+/g, '_').replace(/[^\w_.-]/g, '') + '.json';
                    
                    const flashcardsValid = importedData.flashcards.every(fc => typeof fc.question === 'string' && typeof fc.answer === 'string');
                    const qcmValid = importedData.qcm.every(q => {
                         if (typeof q.question !== 'string' || !Array.isArray(q.options) || typeof q.correctAnswer !== 'string') return false;
                         return q.options.includes(q.correctAnswer);
                    });

                    if (!flashcardsValid || !qcmValid) {
                        ioFeedback.textContent = "Erreur: Structure interne du cours JSON invalide pour téléversement GitHub.";
                        ioFeedback.style.color = "red";
                        setTimeout(() => { ioFeedback.textContent = ''; importFile.value = '';}, 3000);
                        return false;
                    }
                    
                    const success = await uploadCourseToGitHub(fileNameForGithub, fileContent, pat, `Ajout/Mise à jour du cours: ${importedData.title}`);
                    if (success) {
                        ioFeedback.textContent = `Cours "${importedData.title}" traité pour GitHub! Rafraîchissement des cours partagés...`;
                        ioFeedback.style.color = "green";
                        await loadCoursesFromGitHub(); 
                        populateCourseList();
                    } 
                    setTimeout(() => { ioFeedback.textContent = ''; importFile.value = '';}, success ? 5000 : 3000);
                    return success;
                } else {
                    ioFeedback.textContent = "Erreur : Le fichier pour GitHub doit être un objet de cours unique (avec title, flashcards, qcm).";
                    ioFeedback.style.color = "red";
                    setTimeout(() => { ioFeedback.textContent = ''; importFile.value = '';}, 3000);
                    return false;
                }
            } else {
                // Importation locale
                let coursesAddedCount = 0;
                let coursesUpdatedCount = 0;
                let coursesSkippedCount = 0;
                let coursesToProcess = {};

                if (importedData && typeof importedData.title === 'string' && Array.isArray(importedData.flashcards) && Array.isArray(importedData.qcm)) {
                    const tempKey = "imported-" + importedData.title.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
                    coursesToProcess[tempKey] = importedData;
                } else if (typeof importedData === 'object' && importedData !== null) {
                    coursesToProcess = importedData;
                } else {
                     ioFeedback.textContent = "Erreur : Format de fichier d'importation non reconnu.";
                     ioFeedback.style.color = "red";
                     setTimeout(() => { ioFeedback.textContent = ''; importFile.value = '';}, 3000);
                     return false;
                }

                for (const keyInImport in coursesToProcess) {
                    if (Object.hasOwnProperty.call(coursesToProcess, keyInImport)) {
                        const course = coursesToProcess[keyInImport];
                         if (course && typeof course.title === 'string' && Array.isArray(course.flashcards) && Array.isArray(course.qcm)) {
                            const flashcardsValid = course.flashcards.every(fc => typeof fc.question === 'string' && typeof fc.answer === 'string');
                            const qcmValid = course.qcm.every(q => {
                                if (typeof q.question !== 'string' || !Array.isArray(q.options) || typeof q.correctAnswer !== 'string') return false;
                                return q.options.includes(q.correctAnswer);
                            });

                            if (flashcardsValid && qcmValid) {
                                const githubEquivalentKey = keyInImport.startsWith("user-") ? keyInImport.substring(5).split('-').slice(0,-1).join('-') : keyInImport.toLowerCase().replace(/\s+/g, '-');
                                const githubEquivalentKeyFromName = course.title.toLowerCase().replace(/\s+/g, '_').replace(/[^\w_.-]/g, '');

                                if (gitHubCoursesData[githubEquivalentKey] || gitHubCoursesData[githubEquivalentKeyFromName]) {
                                    console.warn(`IMPORT_SKIP_LOCAL: Le cours importé "${course.title}" (clé: ${keyInImport}) correspond à un cours partagé GitHub et ne sera pas ajouté aux cours personnels.`);
                                    coursesSkippedCount++;
                                } else {
                                    const localKey = keyInImport.startsWith("user-") ? keyInImport : "user-" + course.title.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
                                    if (userCoursesData[localKey]) {
                                        coursesUpdatedCount++;
                                    } else {
                                        coursesAddedCount++;
                                    }
                                    userCoursesData[localKey] = course; 
                                }
                            } else { coursesSkippedCount++; }
                        } else { coursesSkippedCount++; }
                    }
                }
                if (coursesAddedCount > 0 || coursesUpdatedCount > 0) {
                    saveUserCoursesToLocalStorage();
                    populateCourseList();
                    ioFeedback.textContent = `${coursesAddedCount} cours personnels ajoutés, ${coursesUpdatedCount} mis à jour.`;
                    if (coursesSkippedCount > 0) ioFeedback.textContent += ` ${coursesSkippedCount} ignorés.`;
                    ioFeedback.style.color = "green";
                } else if (coursesSkippedCount > 0) {
                    ioFeedback.textContent = `Aucun nouveau cours personnel importé. ${coursesSkippedCount} ignorés.`;
                    ioFeedback.style.color = "orange";
                } else {
                    ioFeedback.textContent = "Aucun cours valide à importer localement trouvé dans le fichier.";
                    ioFeedback.style.color = "orange";
                }
                setTimeout(() => { ioFeedback.textContent = ''; importFile.value = '';}, 5000);
                return true;
            }
        }
        async function uploadCourseToGitHub(fileName, jsonContentString, pat, commitMessage) { 
            const apiUrl = `https://api.github.com/repos/${GITHUB_USER_REPO}/contents/${GITHUB_COURSES_DIRECTORY_PATH}/${fileName}`;
            console.log(`GITHUB_UPLOAD: Tentative de téléversement vers ${apiUrl}`);
            
            const contentBase64 = btoa(unescape(encodeURIComponent(jsonContentString)));
            let sha = null;
            try {
                const getFileResponse = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 'Authorization': `token ${pat}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (getFileResponse.ok) {
                    const fileData = await getFileResponse.json();
                    sha = fileData.sha;
                    console.log(`GITHUB_UPLOAD: Fichier "${fileName}" existant trouvé avec SHA: ${sha}. Il sera mis à jour.`);
                    commitMessage = `Mise à jour du cours: ${JSON.parse(jsonContentString).title || fileName}`;
                } else if (getFileResponse.status !== 404) { 
                    const errorData = await getFileResponse.json();
                    console.error("GITHUB_UPLOAD: Erreur vérification fichier:", getFileResponse.status, errorData);
                    ioFeedback.textContent = `Erreur GitHub (${getFileResponse.status}) vérification: ${errorData.message || 'Erreur'}`;
                    ioFeedback.style.color = "red";
                    return false;
                }
            } catch (error) {
                console.error("GITHUB_UPLOAD: Erreur réseau vérification fichier:", error);
            }

            const bodyPayload = {
                message: commitMessage,
                content: contentBase64,
                branch: GITHUB_BRANCH
            };
            if (sha) { 
                bodyPayload.sha = sha;
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${pat}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyPayload)
                });

                if (response.ok) {
                    const responseData = await response.json();
                    console.log("GITHUB_UPLOAD: Fichier téléversé/mis à jour:", responseData);
                    return true;
                } else {
                    const errorData = await response.json();
                    console.error("GITHUB_UPLOAD: Erreur téléversement:", response.status, errorData);
                    ioFeedback.textContent = `Erreur GitHub (${response.status}) téléversement: ${errorData.message || 'Erreur'}`;
                    ioFeedback.style.color = "red";
                    return false;
                }
            } catch (error) {
                console.error("GITHUB_UPLOAD: Erreur réseau téléversement:", error);
                ioFeedback.textContent = "Erreur réseau lors du téléversement sur GitHub.";
                ioFeedback.style.color = "red";
                return false;
            }
        }

        // --- Écouteurs d'événements ---
        showAddCourseSectionBtn.addEventListener('click', showAddCourseScreen);
        saveCourseBtn.addEventListener('click', saveNewCourse);
        backToWelcomeFromAddBtn.addEventListener('click', showWelcomeScreen);
                
        showManualPromptBtn.addEventListener('click', () => {
            manualPromptContainer.classList.toggle('hidden');
            if (!manualPromptContainer.classList.contains('hidden')) {
                manualGeminiPromptTextarea.value = GEMINI_PROMPT_FOR_USER_MANUAL_GENERATION;
            }
        });

        copyManualPromptBtn.addEventListener('click', () => {
            fallbackCopyTextToClipboard(manualGeminiPromptTextarea.value, copyManualPromptFeedback, "Prompt copié !", "Échec copie. Copiez manuellement.");
        });
        
        // if(copyGithubJsonBtn) { // Cette condition n'est plus nécessaire car le bouton est retiré
        //     copyGithubJsonBtn.addEventListener('click', () => {
        //         const textToCopy = githubInstructionsContentElement.textContent;
        //         fallbackCopyTextToClipboard(textToCopy, copyGithubJsonFeedback, "JSON Copié !", "Échec copie JSON. Copiez manuellement.");
        //     });
        // }


        function fallbackCopyTextToClipboard(text, feedbackElement, successMessage, errorMessage) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    feedbackElement.textContent = successMessage;
                    feedbackElement.style.color = "green";
                } else {
                    feedbackElement.textContent = errorMessage;
                    feedbackElement.style.color = "red";
                }
            } catch (err) {
                console.error("COPY_FALLBACK_ERROR: ", err);
                feedbackElement.textContent = errorMessage;
                feedbackElement.style.color = "red";
            }
            feedbackElement.classList.remove('hidden');
            setTimeout(() => { feedbackElement.classList.add('hidden'); }, 3000);
            document.body.removeChild(textArea);
        }


        uploadToGithubCheckbox.addEventListener('change', function() {
            if (this.checked) {
                adminGithubUploadOptionsDiv.classList.remove('hidden');
                confirmLocalImportBtn.classList.add('hidden'); 
            } else {
                adminGithubUploadOptionsDiv.classList.add('hidden');
                confirmLocalImportBtn.classList.remove('hidden'); 
            }
        });

        importFile.addEventListener('change', (event) => {
            selectedFileForImport = event.target.files[0];
            if (selectedFileForImport) {
                importOptionsContainer.classList.remove('hidden');
                confirmLocalImportBtn.classList.remove('hidden'); 
                uploadToGithubCheckbox.checked = false; 
                adminGithubUploadOptionsDiv.classList.add('hidden'); 
                ioFeedback.textContent = `Fichier "${selectedFileForImport.name}" sélectionné. Choisissez une option d'importation.`;
                ioFeedback.style.color = "#4b5563";
            } else {
                importOptionsContainer.classList.add('hidden');
                ioFeedback.textContent = "";
            }
        });
        
        confirmImportBtn.addEventListener('click', () => { 
            if (!selectedFileForImport) {
                ioFeedback.textContent = "Aucun fichier sélectionné pour l'importation.";
                ioFeedback.style.color = "red";
                return;
            }
            const pat = githubPatInput.value.trim();

            if (!pat) {
                ioFeedback.textContent = "Veuillez fournir un Token d'Accès Personnel GitHub (PAT) pour téléverser.";
                ioFeedback.style.color = "red";
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                await processImport(e.target.result, true, pat); 
                importFile.value = ''; 
                selectedFileForImport = null;
                importOptionsContainer.classList.add('hidden');
                githubPatInput.value = ''; 
            };
            reader.readAsText(selectedFileForImport);
        });

        confirmLocalImportBtn.addEventListener('click', () => {
            if (!selectedFileForImport) {
                ioFeedback.textContent = "Aucun fichier sélectionné pour l'importation locale.";
                ioFeedback.style.color = "red";
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                await processImport(e.target.result, false, null); 
                importFile.value = ''; 
                selectedFileForImport = null;
                importOptionsContainer.classList.add('hidden');
            };
            reader.readAsText(selectedFileForImport);
        });


        showFlashcardsBtn.addEventListener('click', showFlashcardsScreen);
        showQcmBtn.addEventListener('click', showQcmScreen);

        flashcardElement.addEventListener('click', flipFlashcard); 
        nextFlashcardBtn.addEventListener('click', nextFlashcard);

        submitQcmBtn.addEventListener('click', submitQcm);
        nextQcmBtn.addEventListener('click', nextQcm);

        backToWelcomeFromModeBtn.addEventListener('click', showWelcomeScreen);
        backToModeSelectionFromFlashcardsBtn.addEventListener('click', showModeSelectionScreen);
        backToModeSelectionFromQcmBtn.addEventListener('click', showModeSelectionScreen);

        exportCoursesBtn.addEventListener('click', openExportModal); 

        downloadSelectedCoursesBtn.addEventListener('click', handleDownloadSelected);
        closeExportModalBtn.addEventListener('click', () => {
            exportModal.classList.add('hidden');
        });


        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', async () => {
            // if(githubRepoLink && GITHUB_USER_REPO && GITHUB_BRANCH && GITHUB_COURSES_DIRECTORY_PATH) { // Retiré car githubInstructionsDiv est retiré
            //     githubRepoLink.href = `https://github.com/${GITHUB_USER_REPO}/tree/${GITHUB_BRANCH}/${GITHUB_COURSES_DIRECTORY_PATH}`;
            // } else if (githubRepoLink) {
            //     githubRepoLink.href = `https://github.com/${GITHUB_USER_REPO}`; 
            // }
            
            loadUserCoursesFromLocalStorage(); 
            await loadCoursesFromGitHub();     
            showWelcomeScreen(); 
        });
    </script>
</body>
</html>
