<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outil de révision multi-cours</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .flashcard-container {
            perspective: 1000px;
            min-height: 200px;
        }
        .flashcard {
            width: 100%;
            height: 200px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            text-align: center;
        }
        .flashcard-front {
            background-color: #ffffff;
            color: #1f2937;
        }
        .flashcard-back {
            background-color: #4b5563;
            color: #ffffff;
            transform: rotateY(180deg);
        }
        .qcm-option {
            transition: background-color 0.3s;
        }
        .qcm-option:hover {
            background-color: #e5e7eb;
        }
        .correct-answer {
            background-color: #d1fae5 !important;
            border-left: 4px solid #10b981;
        }
        .incorrect-answer {
            background-color: #fee2e2 !important;
            border-left: 4px solid #ef4444;
        }
        .btn {
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .feedback-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-weight: 500;
            text-align: center;
        }
        .feedback-correct {
            background-color: #d1fae5;
            color: #065f46;
        }
        .feedback-incorrect {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .hidden {
            display: none;
        }
        .question-counter {
            font-size: 0.9em;
            color: #6b7280; 
            margin-bottom: 1rem;
            text-align: center;
        }
        #addCoursePromptContainer pre, #newCourseData {
            font-family: monospace;
            font-size: 0.9em;
            border: 1px solid #d1d5db;
            padding: 8px;
            border-radius: 6px;
            background-color: #f9fafb;
            white-space: pre-wrap; 
            word-wrap: break-word; 
            max-height: 200px;
            overflow-y: auto;
        }
         #newCourseData {
            min-height: 150px;
         }
        .copy-feedback {
            font-size: 0.8rem;
            color: #4b5563;
            margin-left: 8px;
        }
        .course-button-container {
            display: inline-flex; 
            align-items: center;
            margin-right: 8px; 
            margin-bottom: 8px; 
        }
        .delete-course-btn {
            background-color: transparent;
            border: none;
            color: #ef4444; 
            font-size: 1.2em;
            font-weight: bold;
            margin-left: 5px;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
        }
        .delete-course-btn:hover {
            color: #dc2626; 
        }
        .course-section-title {
            font-size: 1.1em;
            font-weight: 500;
            color: #374151; 
            margin-bottom: 0.75rem;
            margin-top: 1rem;
            text-align: left;
        }
        #loadingMessage, #noGitHubCoursesMessage { /* Combined for GitHub loading status */
            text-align: center;
            padding: 10px; /* Reduced padding */
            font-style: italic;
            color: #4b5563;
        }
        .io-section {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .io-section h3 {
            font-size: 1.1em;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        #importFile {
            display: none; 
        }
        .import-label-btn {
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-lg p-6 md:p-8">
        <header class="mb-6 text-center">
            <h1 id="mainTitle" class="text-3xl font-bold text-gray-800">Mon Outil de Révision</h1>
        </header>

        <section id="welcomeSection" class="py-10">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Choisissez un cours à réviser :</h2>
            
            <div>
                <h3 class="course-section-title">Cours partagés (depuis GitHub) :</h3>
                <div id="githubCourseListContainer" class="flex flex-wrap justify-center md:justify-start">
                    {/* Les boutons des cours GitHub seront injectés ici */}
                </div>
                 <p id="loadingMessage">Chargement des cours depuis GitHub...</p>
                 <p id="noGitHubCoursesMessage" class="text-gray-500 text-sm mt-2 text-center md:text-left hidden">Aucun cours partagé n'a pu être chargé depuis GitHub. Vérifiez la configuration et les fichiers.</p>
            </div>

            <div class="mt-6">
                <h3 class="course-section-title">Vos cours personnels (stockés localement) :</h3>
                <div id="localCourseListContainer" class="flex flex-wrap justify-center md:justify-start">
                    {/* Les boutons des cours locaux seront injectés ici */}
                </div>
                <p id="noLocalCoursesMessage" class="text-gray-500 text-sm mt-2 text-center md:text-left hidden">Aucun cours personnel ajouté pour le moment.</p>
            </div>

            <div class="text-center mt-8">
                <button id="showAddCourseSectionBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md">Ajouter un cours personnel</button>
            </div>

            <div class="io-section text-center md:text-left">
                <h3 class="text-center md:text-left">Gestion des données des cours :</h3>
                <div class="flex flex-col md:flex-row justify-center md:justify-start space-y-2 md:space-y-0 md:space-x-3 mt-2">
                    <button id="exportCoursesBtn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md">Exporter tous les cours</button>
                    <label for="importFile" class="btn bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md import-label-btn">Importer des cours personnels</label>
                    <input type="file" id="importFile" accept=".json">
                </div>
                <p id="ioFeedback" class="text-sm text-gray-600 mt-3 text-center md:text-left"></p>
            </div>
        </section>

        <section id="addCourseSection" class="hidden py-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Ajouter un nouveau cours personnel</h2>
            
            <div class="mb-4">
                <label for="newCourseName" class="block text-sm font-medium text-gray-700 mb-1">Nom du nouveau cours :</label>
                <input type="text" id="newCourseName" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ex: Mon Cours d'Histoire">
            </div>

            <div class="mb-4">
                <p class="block text-sm font-medium text-gray-700 mb-1">1. Copiez le prompt suivant et utilisez-le avec Gemini (ou un outil similaire) en lui fournissant le contenu de votre cours :</p>
                <div id="addCoursePromptContainer" class="bg-gray-50 p-3 rounded-md border">
                    <pre id="addCoursePrompt"></pre>
                </div>
                <button id="copyPromptBtn" class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-md shadow-sm mt-2 text-xs">Copier le Prompt</button>
                <span id="copyPromptFeedback" class="copy-feedback hidden"></span>
            </div>

            <div class="mb-6">
                <label for="newCourseData" class="block text-sm font-medium text-gray-700 mb-1">2. Collez ici les données JSON générées (doit contenir 'title', 'flashcards', 'qcm') :</label>
                <textarea id="newCourseData" rows="8" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Collez le JSON ici..."></textarea>
            </div>
            
            <div id="addCourseFeedback" class="feedback-message hidden mb-4"></div>

            <div class="flex justify-center space-x-4">
                <button id="saveCourseBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Sauvegarder le cours</button>
                <button id="backToWelcomeFromAddBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Retour à l'accueil</button>
            </div>
        </section>


        <section id="modeSelectionSection" class="hidden text-center py-10">
            <h2 id="modeSelectionTitle" class="text-2xl font-semibold text-gray-700 mb-6"></h2>
            <div class="space-y-4 md:space-y-0 md:space-x-4 md:flex md:justify-center">
                <button id="showFlashcardsBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md w-full md:w-auto">Cartes Flash</button>
                <button id="showQcmBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg shadow-md w-full md:w-auto">QCM</button>
            </div>
            <button id="backToWelcomeFromModeBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md mt-8">Retour à l'accueil</button>
        </section>

        <section id="flashcardsSection" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2 text-center">Cartes Flash</h2>
            <div id="flashcardCounter" class="question-counter"></div>
            <div id="flashcardContainer" class="flashcard-container mb-4">
                <div id="flashcard" class="flashcard">
                    <div class="flashcard-face flashcard-front">
                        <p id="flashcardQuestion" class="text-lg"></p>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <p id="flashcardAnswer" class="text-lg"></p>
                    </div>
                </div>
            </div>
            <div id="flashcardMessage" class="text-sm text-gray-500 text-center mb-4 h-6">Cliquez sur la carte pour voir la réponse.</div>
            <div class="flex justify-center space-x-4">
                <button id="nextFlashcardBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md">Suivante</button>
            </div>
            <button id="backToModeSelectionFromFlashcardsBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md mt-6 block mx-auto">Retour au choix du mode</button>
        </section>

        <section id="qcmSection" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2 text-center">Questionnaire à Choix Multiples</h2>
            <div id="qcmCounter" class="question-counter"></div>
            <div id="qcmContainer" class="bg-gray-50 p-6 rounded-lg shadow-inner">
                <p id="qcmQuestionElement" class="text-lg font-medium text-gray-800 mb-4"></p> 
                <div id="qcmOptions" class="space-y-3 mb-4"></div>
                <div id="qcmFeedback" class="feedback-message hidden"></div>
            </div>
            <div class="mt-6 flex justify-center space-x-4">
                 <button id="submitQcmBtn" class="btn bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-semibold py-2 px-6 rounded-lg shadow-md">Valider</button>
                <button id="nextQcmBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md hidden">Suivant</button>
            </div>
            <button id="backToModeSelectionFromQcmBtn" class="btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md mt-6 block mx-auto">Retour au choix du mode</button>
        </section>
    </div>

    <script>
        const USER_COURSES_LOCAL_STORAGE_KEY = 'revisionAppUserCourses_v2'; // Clé pour les cours personnels
        let gitHubCoursesData = {}; 
        let userCoursesData = {};   
        let currentCourseKey = null;
        let currentFlashcardIndex = 0;
        let currentQcmIndex = 0;
        let selectedQcmOption = null;

        // ===================================================================================
        // CONFIGURATION POUR LE CHARGEMENT DES COURS DEPUIS GITHUB
        // ===================================================================================
        const GITHUB_USER_REPO = 'JulienChoi/cyoutilrevision'; 
        const GITHUB_BRANCH = 'main'; 
        const GITHUB_COURSES_DIRECTORY_PATH = 'cours'; 
        // ===================================================================================

        // --- Éléments du DOM ---
        const mainTitle = document.getElementById('mainTitle');
        const welcomeSection = document.getElementById('welcomeSection');
        const githubCourseListContainer = document.getElementById('githubCourseListContainer');
        const localCourseListContainer = document.getElementById('localCourseListContainer');
        const noLocalCoursesMessage = document.getElementById('noLocalCoursesMessage');
        const showAddCourseSectionBtn = document.getElementById('showAddCourseSectionBtn');
        
        const addCourseSection = document.getElementById('addCourseSection');
        const newCourseNameInput = document.getElementById('newCourseName');
        const addCoursePromptElement = document.getElementById('addCoursePrompt');
        const copyPromptBtn = document.getElementById('copyPromptBtn');
        const copyPromptFeedback = document.getElementById('copyPromptFeedback'); 
        const newCourseDataTextarea = document.getElementById('newCourseData');
        const saveCourseBtn = document.getElementById('saveCourseBtn');
        const backToWelcomeFromAddBtn = document.getElementById('backToWelcomeFromAddBtn');
        const addCourseFeedback = document.getElementById('addCourseFeedback');

        const loadingMessage = document.getElementById('loadingMessage');
        const noGitHubCoursesMessage = document.getElementById('noGitHubCoursesMessage'); // Renommé pour clarté
        
        const modeSelectionSection = document.getElementById('modeSelectionSection');
        const modeSelectionTitle = document.getElementById('modeSelectionTitle');
        
        const showFlashcardsBtn = document.getElementById('showFlashcardsBtn');
        const showQcmBtn = document.getElementById('showQcmBtn');
        
        const flashcardsSection = document.getElementById('flashcardsSection');
        const flashcardElement = document.getElementById('flashcard'); 
        const flashcardQuestion = document.getElementById('flashcardQuestion');
        const flashcardAnswer = document.getElementById('flashcardAnswer');
        const nextFlashcardBtn = document.getElementById('nextFlashcardBtn');
        const flashcardMessage = document.getElementById('flashcardMessage');
        const flashcardCounter = document.getElementById('flashcardCounter');

        const qcmSection = document.getElementById('qcmSection');
        const qcmQuestionElement = document.getElementById('qcmQuestionElement');
        const qcmOptionsContainer = document.getElementById('qcmOptions');
        const submitQcmBtn = document.getElementById('submitQcmBtn');
        const nextQcmBtn = document.getElementById('nextQcmBtn');
        const qcmFeedback = document.getElementById('qcmFeedback');
        const qcmCounter = document.getElementById('qcmCounter');

        const backToWelcomeFromModeBtn = document.getElementById('backToWelcomeFromModeBtn');
        const backToModeSelectionFromFlashcardsBtn = document.getElementById('backToModeSelectionFromFlashcardsBtn');
        const backToModeSelectionFromQcmBtn = document.getElementById('backToModeSelectionFromQcmBtn');
        
        const exportCoursesBtn = document.getElementById('exportCoursesBtn');
        const importFile = document.getElementById('importFile');
        const ioFeedback = document.getElementById('ioFeedback');

        const GEMINI_PROMPT = `Bonjour Gemini, j'ai un cours que j'aimerais transformer en fiches de révision et QCM pour mon outil.

Merci de générer à partir du contenu de cours que je vais vous fournir :
1.  Une liste de cartes flash (questions concises et réponses directes).
2.  Une liste de questions à choix multiples (QCM) avec 3 ou 4 options de réponse et une seule bonne réponse clairement identifiée.

Veuillez fournir la sortie sous la forme d'un unique objet JSON valide, structuré exactement comme suit (ne modifiez pas les noms des clés) :
{
  "title": "METTRE ICI LE TITRE EXACT DU COURS FOURNI",
  "flashcards": [
    { "question": "Question pour la carte flash 1...", "answer": "Réponse pour la carte flash 1..." },
    { "question": "Question pour la carte flash 2...", "answer": "Réponse pour la carte flash 2..." }
  ],
  "qcm": [
    { "question": "Question QCM 1...", "options": ["Option A", "Option B", "Option C", "Option D (si applicable)"], "correctAnswer": "Option correcte pour QCM 1" },
    { "question": "Question QCM 2...", "options": ["Option A", "Option B", "Option C"], "correctAnswer": "Option correcte pour QCM 2" }
  ]
}

Le champ "title" doit être une chaîne de caractères.
"flashcards" doit être un tableau d'objets, chaque objet ayant impérativement les clés "question" et "answer" (chaînes de caractères).
"qcm" doit être un tableau d'objets, chaque objet ayant impérativement les clés "question" (chaîne), "options" (tableau de chaînes), et "correctAnswer" (chaîne de caractères).

**Instruction importante pour les QCM :** La valeur du champ "correctAnswer" doit être une copie **exacte** de l'une des chaînes de caractères fournies dans le tableau "options" pour cette question. N'ajoutez aucun texte supplémentaire, marqueur de citation (comme "[cite: X]"), ou modification à la "correctAnswer" qui ne soit pas présent tel quel dans les "options".

Voici le contenu de mon cours :
[VEUILLEZ COLLER LE CONTENU INTÉGRAL DE VOTRE COURS ICI]`;

        function loadUserCoursesFromLocalStorage() {
            console.log("LOCAL_STORAGE_LOAD: Tentative de chargement des cours utilisateur.");
            const storedUserCourses = localStorage.getItem(USER_COURSES_LOCAL_STORAGE_KEY);
            if (storedUserCourses) {
                try {
                    userCoursesData = JSON.parse(storedUserCourses);
                    if (typeof userCoursesData !== 'object' || userCoursesData === null) {
                        userCoursesData = {}; 
                    }
                    console.log("LOCAL_STORAGE_LOAD: Cours utilisateur chargés:", userCoursesData);
                } catch (error) {
                    console.error("LOCAL_STORAGE_LOAD: Erreur de parsing des cours utilisateur:", error);
                    userCoursesData = {};
                }
            } else {
                userCoursesData = {};
                console.log("LOCAL_STORAGE_LOAD: Aucun cours utilisateur trouvé dans localStorage.");
            }
        }

        function saveUserCoursesToLocalStorage() {
            console.log("LOCAL_STORAGE_SAVE: Tentative de sauvegarde des cours utilisateur:", userCoursesData);
            try {
                localStorage.setItem(USER_COURSES_LOCAL_STORAGE_KEY, JSON.stringify(userCoursesData));
                console.log("LOCAL_STORAGE_SAVE: Cours utilisateur sauvegardés avec succès.");
            } catch (error) {
                console.error("LOCAL_STORAGE_SAVE: Erreur de sauvegarde des cours utilisateur:", error);
                ioFeedback.textContent = "Erreur lors de la sauvegarde des cours personnels.";
                ioFeedback.style.color = "red";
                setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
            }
        }
        
        async function fetchAndValidateCourseContent(downloadUrl, fileNameForLogging) {
            console.log(`GITHUB_FETCH: Tentative de chargement du contenu de ${fileNameForLogging} depuis ${downloadUrl}`);
            try {
                const response = await fetch(downloadUrl);
                if (!response.ok) {
                    console.error(`GITHUB_FETCH: Erreur HTTP! Statut: ${response.status}, Texte: ${response.statusText} pour ${fileNameForLogging} (URL: ${downloadUrl})`);
                    throw new Error(`HTTP error! status: ${response.status} pour ${fileNameForLogging}`);
                }
                const data = await response.json();
                if (data && typeof data.title === 'string' && Array.isArray(data.flashcards) && Array.isArray(data.qcm)) {
                    const flashcardsValid = data.flashcards.every(fc => typeof fc.question === 'string' && typeof fc.answer === 'string');
                    const qcmValid = data.qcm.every(q => {
                        if (typeof q.question !== 'string' || !Array.isArray(q.options) || typeof q.correctAnswer !== 'string') return false;
                        const cleanedCorrectAnswer = q.correctAnswer.replace(/\s*\[cite:.*?\]\s*$/, "").trim();
                        return q.options.includes(cleanedCorrectAnswer);
                    });
                    if (flashcardsValid && qcmValid) {
                        return { key: fileNameForLogging.replace('.json', ''), data: data };
                    } else {
                        console.error(`GITHUB_FETCH: Structure de contenu invalide dans ${fileNameForLogging}.`);
                        return null;
                    }
                } else {
                     console.error(`GITHUB_FETCH: Structure JSON principale invalide pour ${fileNameForLogging}.`);
                    return null;
                }
            } catch (error) {
                console.error(`GITHUB_FETCH: Erreur lors du traitement de ${fileNameForLogging}:`, error);
                return null;
            }
        }

        async function loadCoursesFromGitHub() {
            console.log("GITHUB_FETCH: Début du chargement des cours partagés...");
            loadingMessage.classList.remove('hidden');
            noGitHubCoursesMessage.classList.add('hidden'); 
            
            const apiUrl = `https://api.github.com/repos/${GITHUB_USER_REPO}/contents/${GITHUB_COURSES_DIRECTORY_PATH}?ref=${GITHUB_BRANCH}`;
            console.log(`GITHUB_FETCH: Interrogation API: ${apiUrl}`);

            let filesToFetch = [];
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error(`GITHUB_FETCH: Erreur API GitHub! Statut: ${response.status}, (URL: ${apiUrl})`);
                    throw new Error(`GitHub API error! status: ${response.status}`);
                }
                const directoryContents = await response.json();
                if (Array.isArray(directoryContents)) {
                    filesToFetch = directoryContents
                        .filter(item => item.type === 'file' && item.name.endsWith('.json'))
                        .map(item => ({ name: item.name, download_url: item.download_url }));
                    console.log("GITHUB_FETCH: Fichiers JSON trouvés:", filesToFetch.map(f => f.name));
                } else {
                    console.error("GITHUB_FETCH: Réponse API GitHub non conforme (pas un tableau).", directoryContents);
                }
            } catch (error) {
                console.error("GITHUB_FETCH: Erreur récupération liste fichiers:", error);
                loadingMessage.classList.add('hidden');
                noGitHubCoursesMessage.classList.remove('hidden'); 
                return; 
            }

            if (filesToFetch.length === 0) {
                console.warn("GITHUB_FETCH: Aucun fichier .json trouvé dans le dossier GitHub.");
                loadingMessage.classList.add('hidden');
                noGitHubCoursesMessage.classList.remove('hidden'); 
            }

            const coursePromises = filesToFetch.map(fileInfo => fetchAndValidateCourseContent(fileInfo.download_url, fileInfo.name));
            const results = await Promise.all(coursePromises);

            gitHubCoursesData = {}; 
            results.forEach(result => {
                if (result && result.data) {
                    gitHubCoursesData[result.key] = result.data;
                    console.log(`GITHUB_FETCH: Cours partagé "${result.data.title}" (clé: ${result.key}) chargé.`);
                }
            });
            
            loadingMessage.classList.add('hidden');
            if (Object.keys(gitHubCoursesData).length === 0 && filesToFetch.length > 0) {
                 console.warn("GITHUB_FETCH: Fichiers JSON détectés mais aucun cours partagé n'a pu être chargé correctement.");
                 noGitHubCoursesMessage.classList.remove('hidden');
            } else if (filesToFetch.length === 0) {
                noGitHubCoursesMessage.classList.remove('hidden'); 
            } else {
                noGitHubCoursesMessage.classList.add('hidden'); 
            }
        }

        function showWelcomeScreen() {
            mainTitle.textContent = "Mon Outil de Révision";
            welcomeSection.classList.remove('hidden');
            addCourseSection.classList.add('hidden');
            modeSelectionSection.classList.add('hidden');
            flashcardsSection.classList.add('hidden');
            qcmSection.classList.add('hidden');
            currentCourseKey = null;
            populateCourseList();
        }

        function showAddCourseScreen() {
            mainTitle.textContent = "Ajouter un Nouveau Cours Personnel";
            welcomeSection.classList.add('hidden');
            addCourseSection.classList.remove('hidden');
            modeSelectionSection.classList.add('hidden');
            flashcardsSection.classList.add('hidden');
            qcmSection.classList.add('hidden');
            addCoursePromptElement.textContent = GEMINI_PROMPT;
            newCourseNameInput.value = '';
            newCourseDataTextarea.value = '';
            addCourseFeedback.classList.add('hidden');
            copyPromptFeedback.classList.add('hidden'); 
        }
        
        function populateCourseList() {
            githubCourseListContainer.innerHTML = ''; 
            localCourseListContainer.innerHTML = '';
            let localCoursesExist = false;
            
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };

            // Afficher les cours GitHub
            Object.keys(gitHubCoursesData).forEach(key => {
                const course = gitHubCoursesData[key];
                const buttonContainer = document.createElement('div');
                buttonContainer.classList.add('course-button-container');
                const button = createCourseButton(key, course.title, combinedCourses);
                buttonContainer.appendChild(button);
                githubCourseListContainer.appendChild(buttonContainer);
            });
             if (Object.keys(gitHubCoursesData).length === 0 && loadingMessage.classList.contains('hidden')) {
                 noGitHubCoursesMessage.classList.remove('hidden');
            } else {
                 noGitHubCoursesMessage.classList.add('hidden');
            }


            // Afficher les cours locaux
            Object.keys(userCoursesData).forEach(key => {
                if (!gitHubCoursesData[key]) { // S'assurer de ne pas dupliquer si une clé locale correspond à une clé GitHub
                    localCoursesExist = true;
                    const course = userCoursesData[key];
                    const buttonContainer = document.createElement('div');
                    buttonContainer.classList.add('course-button-container');
                    const button = createCourseButton(key, course.title, combinedCourses);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&#x2715;'; 
                    deleteBtn.classList.add('delete-course-btn');
                    deleteBtn.title = `Supprimer le cours "${course.title}"`;
                    deleteBtn.addEventListener('click', (event) => {
                        event.stopPropagation(); 
                        deleteUserCourse(key, course.title);
                    });
                    buttonContainer.appendChild(button);
                    buttonContainer.appendChild(deleteBtn);
                    localCourseListContainer.appendChild(buttonContainer);
                }
            });

            if (localCoursesExist) {
                noLocalCoursesMessage.classList.add('hidden');
            } else {
                noLocalCoursesMessage.classList.remove('hidden');
            }
        }

        function createCourseButton(key, title, sourceData) {
            const button = document.createElement('button');
            button.dataset.course = key;
            button.classList.add('course-btn', 'btn', 'text-white', 'font-semibold', 'py-2', 'px-4', 'rounded-lg', 'shadow-md');
            const colors = ['bg-sky-600 hover:bg-sky-700', 'bg-teal-600 hover:bg-teal-700', 'bg-indigo-600 hover:bg-indigo-700', 'bg-rose-600 hover:bg-rose-700', 'bg-amber-600 hover:bg-amber-700'];
            // Pour la couleur, on se base sur l'index dans l'ensemble des cours combinés pour varier
            const allKeys = Object.keys({...gitHubCoursesData, ...userCoursesData});
            const colorIndex = allKeys.indexOf(key) % colors.length;
            const colorClass = colors[colorIndex >= 0 ? colorIndex : 0]; // S'assurer que l'index est valide
            button.classList.add(...colorClass.split(' '));
            button.textContent = title;
            button.addEventListener('click', () => {
                currentCourseKey = key; 
                currentFlashcardIndex = 0; 
                currentQcmIndex = 0;
                showModeSelectionScreen();
            });
            return button;
        }
        
        function deleteUserCourse(courseKey, courseTitle) {
            console.log(`LOCAL_STORAGE_DELETE: Suppression du cours utilisateur. Clé: ${courseKey}, Titre: ${courseTitle}`);
            delete userCoursesData[courseKey]; 
            saveUserCoursesToLocalStorage();
            populateCourseList(); 
            ioFeedback.textContent = `Le cours personnel "${courseTitle}" a été supprimé.`;
            ioFeedback.style.color = "orange";
            setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
        }


        function showModeSelectionScreen() {
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!currentCourseKey || !combinedCourses[currentCourseKey]) { 
                 console.error("Attempting to access non-existent course:", currentCourseKey);
                 showWelcomeScreen(); 
                 return;
            }
            mainTitle.textContent = `Révision : ${combinedCourses[currentCourseKey].title}`;
            modeSelectionTitle.textContent = `Cours : ${combinedCourses[currentCourseKey].title}. Choisissez un mode :`;
            welcomeSection.classList.add('hidden');
            addCourseSection.classList.add('hidden');
            modeSelectionSection.classList.remove('hidden');
            flashcardsSection.classList.add('hidden');
            qcmSection.classList.add('hidden');
        }

        function showFlashcardsScreen() {
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!currentCourseKey || !combinedCourses[currentCourseKey]) { showWelcomeScreen(); return; }
            mainTitle.textContent = `Cartes Flash : ${combinedCourses[currentCourseKey].title}`;
            modeSelectionSection.classList.add('hidden');
            flashcardsSection.classList.remove('hidden');
            qcmSection.classList.add('hidden');
            displayFlashcard();
        }

        function showQcmScreen() {
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!currentCourseKey || !combinedCourses[currentCourseKey]) { showWelcomeScreen(); return; }
            mainTitle.textContent = `QCM : ${combinedCourses[currentCourseKey].title}`;
            modeSelectionSection.classList.add('hidden');
            flashcardsSection.classList.add('hidden');
            qcmSection.classList.remove('hidden');
            displayQcm();
        }
        
        function displayFlashcard() {
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!combinedCourses[currentCourseKey] || !combinedCourses[currentCourseKey].flashcards) { 
                flashcardQuestion.textContent = "Erreur : Données de flashcards non trouvées pour ce cours.";
                flashcardElement.classList.add('hidden');
                nextFlashcardBtn.classList.add('hidden');
                flashcardCounter.textContent = "0/0";
                return;
            }
            const courseFlashcards = combinedCourses[currentCourseKey].flashcards;
            if (courseFlashcards.length === 0) { 
                flashcardQuestion.textContent = "Aucune carte flash disponible pour ce cours.";
                flashcardAnswer.textContent = "";
                flashcardMessage.textContent = "Vérifiez le fichier JSON du cours.";
                nextFlashcardBtn.classList.add('hidden');
                flashcardElement.classList.add('hidden');
                flashcardCounter.textContent = "0/0";
                return;
            }
            flashcardElement.classList.remove('hidden');
            nextFlashcardBtn.classList.remove('hidden');
            
            const currentCard = courseFlashcards[currentFlashcardIndex];
            flashcardQuestion.textContent = currentCard.question;
            flashcardAnswer.textContent = currentCard.answer;
            flashcardElement.classList.remove('is-flipped');
            flashcardMessage.textContent = "Cliquez sur la carte pour voir la réponse.";
            flashcardCounter.textContent = `${currentFlashcardIndex + 1}/${courseFlashcards.length}`;
        }

        function flipFlashcard() {
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            if (!currentCourseKey || !combinedCourses[currentCourseKey] || !combinedCourses[currentCourseKey].flashcards || combinedCourses[currentCourseKey].flashcards.length === 0) return;
            flashcardElement.classList.toggle('is-flipped');
             if (flashcardElement.classList.contains('is-flipped')) {
                flashcardMessage.textContent = "Cliquez sur la carte pour voir la question.";
            } else {
                flashcardMessage.textContent = "Cliquez sur la carte pour voir la réponse.";
            }
        }

        function nextFlashcard() {
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            const courseFlashcards = combinedCourses[currentCourseKey].flashcards;
            if (!courseFlashcards || courseFlashcards.length === 0) return;
            currentFlashcardIndex = (currentFlashcardIndex + 1) % courseFlashcards.length;
            displayFlashcard();
        }

        function displayQcm() {
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
             if (!combinedCourses[currentCourseKey] || !combinedCourses[currentCourseKey].qcm) { 
                qcmQuestionElement.textContent = "Erreur : Données de QCM non trouvées pour ce cours.";
                qcmOptionsContainer.innerHTML = "";
                submitQcmBtn.classList.add('hidden');
                nextQcmBtn.classList.add('hidden');
                qcmCounter.textContent = "0/0";
                return;
            }
            const courseQCMs = combinedCourses[currentCourseKey].qcm;
            if (courseQCMs.length === 0) { 
                qcmQuestionElement.textContent = "Aucun QCM disponible pour ce cours.";
                qcmOptionsContainer.innerHTML = "";
                submitQcmBtn.classList.add('hidden');
                nextQcmBtn.classList.add('hidden');
                qcmFeedback.classList.add('hidden');
                qcmCounter.textContent = "0/0";
                return;
            }

            submitQcmBtn.classList.remove('hidden');
            nextQcmBtn.classList.add('hidden');
            qcmFeedback.classList.add('hidden');
            qcmFeedback.textContent = '';
            qcmFeedback.className = 'feedback-message hidden';

            const currentQ = courseQCMs[currentQcmIndex];
            qcmQuestionElement.textContent = currentQ.question;
            qcmOptionsContainer.innerHTML = ''; 
            qcmCounter.textContent = `${currentQcmIndex + 1}/${courseQCMs.length}`;

            currentQ.options.forEach(option => {
                const optionId = `qcm-option-${option.replace(/\s+/g, '-').replace(/[^\w-]/g, '')}`;
                const div = document.createElement('div');
                div.classList.add('qcm-option', 'p-3', 'bg-white', 'rounded-lg', 'border', 'border-gray-300', 'cursor-pointer', 'hover:bg-gray-100');
                
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'qcmOption';
                input.value = option;
                input.id = optionId; 
                input.classList.add('mr-3', 'accent-blue-500');

                const label = document.createElement('label');
                label.htmlFor = optionId;
                label.textContent = option;
                label.classList.add('text-gray-700', 'w-full', 'cursor-pointer');

                div.appendChild(input);
                div.appendChild(label);
                
                div.addEventListener('click', () => {
                    document.querySelectorAll('#qcmOptions > div').forEach(d => d.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50'));
                    div.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
                    input.checked = true; 
                    selectedQcmOption = option;
                    submitQcmBtn.disabled = false; 
                });
                qcmOptionsContainer.appendChild(div);
            });
            selectedQcmOption = null; 
            submitQcmBtn.disabled = true; 
        }

        function submitQcm() {
            if (selectedQcmOption === null) {
                qcmFeedback.textContent = "Veuillez sélectionner une réponse.";
                qcmFeedback.className = 'feedback-message feedback-incorrect';
                qcmFeedback.classList.remove('hidden');
                return;
            }
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            const currentQ = combinedCourses[currentCourseKey].qcm[currentQcmIndex];
            const cleanedStoredCorrectAnswer = currentQ.correctAnswer.replace(/\s*\[cite:.*?\]\s*$/, "").trim();

            const isCorrect = selectedQcmOption === cleanedStoredCorrectAnswer;

            qcmFeedback.classList.remove('hidden');
            if (isCorrect) {
                qcmFeedback.textContent = "Bonne réponse !";
                qcmFeedback.className = 'feedback-message feedback-correct';
            } else {
                qcmFeedback.textContent = `Mauvaise réponse. La bonne réponse était : ${cleanedStoredCorrectAnswer}`;
                qcmFeedback.className = 'feedback-message feedback-incorrect';
            }

            const optionsDivs = qcmOptionsContainer.querySelectorAll('div');
            optionsDivs.forEach(div => {
                const input = div.querySelector('input');
                div.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50'); 
                div.style.pointerEvents = 'none'; 

                if (input.value === cleanedStoredCorrectAnswer) { 
                    div.classList.add('correct-answer');
                } else if (input.value === selectedQcmOption && !isCorrect) {
                    div.classList.add('incorrect-answer');
                }
            });

            submitQcmBtn.classList.add('hidden'); 
            nextQcmBtn.classList.remove('hidden'); 
        }

        function nextQcm() {
            const combinedCourses = {...gitHubCoursesData, ...userCoursesData };
            const courseQCMs = combinedCourses[currentCourseKey].qcm;
            if (!courseQCMs || courseQCMs.length === 0) return;
            currentQcmIndex = (currentQcmIndex + 1) % courseQCMs.length;
            displayQcm();
            submitQcmBtn.classList.remove('hidden'); 
            nextQcmBtn.classList.add('hidden'); 
            qcmFeedback.classList.add('hidden'); 
            
            const optionsDivs = qcmOptionsContainer.querySelectorAll('div');
            optionsDivs.forEach(div => {
                div.style.pointerEvents = 'auto';
            });
        }

        function saveNewCourse() {
            const courseName = newCourseNameInput.value.trim();
            const courseDataJSON = newCourseDataTextarea.value.trim();
            addCourseFeedback.classList.add('hidden');

            if (!courseName) {
                addCourseFeedback.textContent = "Veuillez donner un nom à votre cours.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }

            if (!courseDataJSON) {
                addCourseFeedback.textContent = "Veuillez coller les données JSON générées.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }

            let newCourseContent;
            try {
                newCourseContent = JSON.parse(courseDataJSON);
            } catch (error) {
                addCourseFeedback.textContent = "Erreur : Le format JSON est invalide.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                console.error("JSON_PARSE_ERROR: ", error);
                return;
            }

            if (!newCourseContent.title || typeof newCourseContent.title !== 'string' ||
                !Array.isArray(newCourseContent.flashcards) || 
                !Array.isArray(newCourseContent.qcm)) {
                addCourseFeedback.textContent = "Erreur : Structure JSON incorrecte (title, flashcards, qcm requis).";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }
            
            const flashcardsValid = newCourseContent.flashcards.every(fc => typeof fc.question === 'string' && typeof fc.answer === 'string');
            const qcmValid = newCourseContent.qcm.every(q => {
                if (typeof q.question !== 'string' || !Array.isArray(q.options) || typeof q.correctAnswer !== 'string') return false;
                const cleanedCorrectAnswer = q.correctAnswer.replace(/\s*\[cite:.*?\]\s*$/, "").trim();
                return q.options.includes(cleanedCorrectAnswer);
            });

            if (!flashcardsValid || !qcmValid) {
                 addCourseFeedback.textContent = "Erreur : Structure interne des flashcards/QCM incorrecte.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }

            const courseKey = "user-" + courseName.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
            
            if (gitHubCoursesData[courseKey] || gitHubCoursesData[courseName.toLowerCase().replace(/\s+/g, '-')]) { // Check against potential GitHub key format too
                 addCourseFeedback.textContent = "Erreur : Un cours partagé avec un nom/clé similaire existe déjà. Veuillez choisir un autre nom pour votre cours personnel.";
                addCourseFeedback.className = 'feedback-message feedback-incorrect';
                addCourseFeedback.classList.remove('hidden');
                return;
            }

            userCoursesData[courseKey] = {
                title: courseName, 
                flashcards: newCourseContent.flashcards,
                qcm: newCourseContent.qcm 
            };
            
            saveUserCoursesToLocalStorage(); 

            addCourseFeedback.textContent = `Le cours "${courseName}" a été ajouté avec succès !`;
            addCourseFeedback.className = 'feedback-message feedback-correct';
            addCourseFeedback.classList.remove('hidden');
            
            newCourseNameInput.value = ''; 
            newCourseDataTextarea.value = '';

            setTimeout(() => {
                showWelcomeScreen();
            }, 2000);
        }

        function exportCourses() {
            const allCoursesToExport = {...gitHubCoursesData, ...userCoursesData}; 
            if (Object.keys(allCoursesToExport).length === 0) {
                ioFeedback.textContent = "Aucun cours à exporter.";
                ioFeedback.style.color = "orange";
                setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
                return;
            }
            try {
                const jsonData = JSON.stringify(allCoursesToExport, null, 2); 
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mes_cours_revision_complets.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                ioFeedback.textContent = "Tous les cours ont été exportés avec succès !";
                ioFeedback.style.color = "green";
            } catch (error) {
                console.error("EXPORT_ERROR:", error);
                ioFeedback.textContent = "Erreur lors de l'exportation des cours.";
                ioFeedback.style.color = "red";
            }
            setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            ioFeedback.textContent = ''; 
            if (!file) return;

            if (file.type !== "application/json") {
                ioFeedback.textContent = "Erreur : Veuillez sélectionner un fichier JSON.";
                ioFeedback.style.color = "red";
                setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
                importFile.value = ''; 
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                let importedData;
                try {
                    importedData = JSON.parse(e.target.result);
                } catch (error) {
                    console.error("IMPORT_PARSE_ERROR:", error);
                    ioFeedback.textContent = "Erreur : Le fichier JSON importé est invalide.";
                    ioFeedback.style.color = "red";
                    setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
                    importFile.value = ''; 
                    return;
                }

                if (typeof importedData !== 'object' || importedData === null) {
                    ioFeedback.textContent = "Erreur : Le fichier JSON importé n'est pas un objet de cours valide.";
                    ioFeedback.style.color = "red";
                    setTimeout(() => { ioFeedback.textContent = ''; }, 3000);
                    importFile.value = ''; 
                    return;
                }
                
                let coursesAddedCount = 0;
                let coursesUpdatedCount = 0;
                let coursesSkippedCount = 0;

                for (const keyInImport in importedData) {
                    if (Object.hasOwnProperty.call(importedData, keyInImport)) {
                        const course = importedData[keyInImport];
                        if (course && typeof course.title === 'string' && Array.isArray(course.flashcards) && Array.isArray(course.qcm)) {
                            const flashcardsValid = course.flashcards.every(fc => typeof fc.question === 'string' && typeof fc.answer === 'string');
                            const qcmValid = course.qcm.every(q => {
                                if (typeof q.question !== 'string' || !Array.isArray(q.options) || typeof q.correctAnswer !== 'string') return false;
                                const cleanedCorrectAnswer = q.correctAnswer.replace(/\s*\[cite:.*?\]\s*$/, "").trim();
                                return q.options.includes(cleanedCorrectAnswer);
                            });

                            if (flashcardsValid && qcmValid) {
                                // Ne pas écraser ou ajouter si la clé correspond à un cours GitHub
                                if (gitHubCoursesData[keyInImport]) {
                                    console.warn(`IMPORT_SKIP: Le cours importé avec la clé "${keyInImport}" (${course.title}) correspond à un cours partagé GitHub et ne sera pas ajouté aux cours personnels pour éviter les conflits.`);
                                    coursesSkippedCount++;
                                } else { // Ajouter ou mettre à jour dans userCoursesData
                                    if (userCoursesData[keyInImport]) {
                                        coursesUpdatedCount++;
                                    } else {
                                        coursesAddedCount++;
                                    }
                                    userCoursesData[keyInImport] = course; 
                                }
                            } else {
                                console.warn(`IMPORT_INVALID_STRUCTURE: Cours importé avec la clé '${keyInImport}' a une structure interne invalide et a été ignoré.`);
                                coursesSkippedCount++;
                            }
                        } else {
                            console.warn(`IMPORT_INVALID_COURSE: Cours importé avec la clé '${keyInImport}' a une structure principale invalide et a été ignoré.`);
                            coursesSkippedCount++;
                        }
                    }
                }
                
                if (coursesAddedCount > 0 || coursesUpdatedCount > 0) {
                    saveUserCoursesToLocalStorage();
                    populateCourseList();
                    ioFeedback.textContent = `${coursesAddedCount} cours personnels ajoutés, ${coursesUpdatedCount} mis à jour.`;
                    if (coursesSkippedCount > 0) {
                        ioFeedback.textContent += ` ${coursesSkippedCount} cours ignorés (clés réservées ou structure invalide).`;
                    }
                    ioFeedback.style.color = "green";
                } else if (coursesSkippedCount > 0) {
                    ioFeedback.textContent = `Aucun nouveau cours personnel importé. ${coursesSkippedCount} cours ignorés (clés réservées ou structure invalide).`;
                     ioFeedback.style.color = "orange";
                } else {
                     ioFeedback.textContent = "Aucun cours à importer ou structure de fichier non reconnue.";
                     ioFeedback.style.color = "orange";
                }
                setTimeout(() => { ioFeedback.textContent = ''; }, 5000);
                importFile.value = ''; 
            };
            reader.readAsText(file);
        }


        // --- Écouteurs d'événements ---
        showAddCourseSectionBtn.addEventListener('click', showAddCourseScreen);
        saveCourseBtn.addEventListener('click', saveNewCourse);
        backToWelcomeFromAddBtn.addEventListener('click', showWelcomeScreen);
        
        copyPromptBtn.addEventListener('click', () => {
            const textToCopy = GEMINI_PROMPT;
            copyPromptFeedback.classList.add('hidden'); 

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        copyPromptFeedback.textContent = "Copié !";
                        copyPromptFeedback.style.color = "green";
                        copyPromptFeedback.classList.remove('hidden');
                        setTimeout(() => { copyPromptFeedback.classList.add('hidden'); }, 2000);
                    })
                    .catch(err => {
                        console.warn("COPY_FALLBACK: navigator.clipboard.writeText a échoué: ", err);
                        fallbackCopyTextToClipboard(textToCopy);
                    });
            } else {
                console.warn("COPY_FALLBACK: navigator.clipboard non disponible.");
                fallbackCopyTextToClipboard(textToCopy);
            }
        });

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    copyPromptFeedback.textContent = "Copié (fallback) !";
                    copyPromptFeedback.style.color = "green";
                } else {
                    copyPromptFeedback.textContent = "Échec copie. Copiez manuellement.";
                    copyPromptFeedback.style.color = "red";
                }
            } catch (err) {
                console.error("COPY_FALLBACK_ERROR: ", err);
                copyPromptFeedback.textContent = "Échec copie. Copiez manuellement.";
                copyPromptFeedback.style.color = "red";
            }
            copyPromptFeedback.classList.remove('hidden');
            setTimeout(() => { copyPromptFeedback.classList.add('hidden'); }, 3000);
            document.body.removeChild(textArea);
        }


        showFlashcardsBtn.addEventListener('click', showFlashcardsScreen);
        showQcmBtn.addEventListener('click', showQcmScreen);

        flashcardElement.addEventListener('click', flipFlashcard); 
        nextFlashcardBtn.addEventListener('click', nextFlashcard);

        submitQcmBtn.addEventListener('click', submitQcm);
        nextQcmBtn.addEventListener('click', nextQcm);

        backToWelcomeFromModeBtn.addEventListener('click', showWelcomeScreen);
        backToModeSelectionFromFlashcardsBtn.addEventListener('click', showModeSelectionScreen);
        backToModeSelectionFromQcmBtn.addEventListener('click', showModeSelectionScreen);

        exportCoursesBtn.addEventListener('click', exportCourses);
        importFile.addEventListener('change', handleImportFile);

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', async () => {
            showWelcomeScreen(); 
            loadUserCoursesFromLocalStorage(); 
            await loadCoursesFromGitHub(); 
            populateCourseList(); // S'assurer que la liste est peuplée après tous les chargements
        });
    </script>
</body>
</html>
